---
sitemap:
 priority: 1.0
 changefreq: weekly
 lastmod: 2013-09-28T00:00:00
title: "Inventit Iot developer Network | ガイド | ひと通りやってみる"
name: get-started.html
collapse: collapse
layout: base
lang: ja
---
<section class="content">
  <div class="container">
    <div class="row">
    
      <div class="col-lg-3"> 
        <!-- sideMenu -->
	  {% include ja/guides_side_menu.html %}
      <!-- col-lg-3 End --> 
      </div>
      
      <div class="col-lg-9">
        <ul class="breadcrumb">
          <li><a href="index.html">Home&nbsp;</a></li>
          <i class="icon-angle-right"></i>
          <li><a href="guides.html">ガイド&nbsp;</a></li>
          <i class="icon-angle-right"></i>
          <li class="avtive">ひと通りやってみる</li>
        </ul>
        
        <h1>ひと通りやってみる</h1>
        <ul class="nav nav-tabs nav-justified">　
          <li class="active"><a href="#Build-your-first-MOAT-IoT-Application">最初の MOAT IoT アプリ<br />
              をつくってみる</a></li>
          <li><a href="#Checkout-Sample-Project-from-GitHub">GitHubからサンプルコード<br />
              をダウンロードする</a></li>
          <li><a href="#Kick-off-your-first-IoT-app">最初の MOAT IoT アプリ<br />
              を起動する</a></li>
          <li><a href="#Appendix"><br />
              Appendix</a></li>
        </ul>
        
        <div id="build-your-first-moatiot-application">
          <h2>最初の MOAT IoT アプリをつくってみる</h2>
        </div>
        <h3>概要</h3>
        <p>このチュートリアルでは、Inventit IoT Developer Network (IIDN) の Sandbox サーバーへのサインアップ方法と、<a href="https://github.com/inventit/moat-iot-get-started">GitHub</a> で公開している MOAT IoT アプリの構築方法を紹介します。</p>
        <p> このアプリケーションは、以下に示す機能を実際に動作させてみます。
          <ul>
            <li>デバイスのモーションセンサーのデータをアップロードする。</li>
            <li>アップロードされたデータ履歴を閲覧する。</li>
            <li>ブラウザからデバイスにモールス信号を送信し、デバイスを振動させる。</li>
          </ul>
        </p>
        <div class="img">
          <img src="/img/guides/get-started_01.png" alt="Responsive image" class="img-responsive" />
        </div>
        <p>このチュートリアルでは、<strong>コードを修正することはありません</strong>。従って、JavaやRuby、Javascriptの知識は特に必要ありません。</p>
        
        <h3>ビルド環境は必要ですか？</h3>
        <p>このチュートリアルは、強力な仮想マシン管理ツールである<a href="http://www.vagrantup.com/">Vagrant</a>を利用して、<a href="https://www.virtualbox.org/">VirtualBox</a>イメージに従い、MOAT IoT アプリの開発環境をビルドする手順を含んでいます。従って、きちんと事前準備をする必要はありません。<br />
          数行記述すれば、<a href="http://www.vagrantup.com/">Vagrant</a> が面倒をみてくれます。</p>
        
        <h3>では、何をしたらいいの？</h3>
        <p> 最初に、<a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a> (4.3.x) をインストールします。<br />
          次に、<a href="http://downloads.vagrantup.com/">Vagrant</a> をインストールします。(1.5.0以上の最新バージョンをインストールしてください。vagrant gemはくれぐれも利用しないようにして下さい。)<br />
          さあ、GitHubから <a href="https://github.com/inventit/moat-iot-get-started-vagrant">Vagrant Settings for this example app</a>をダウンロードしましょう！</p>
        <div class="bs-callout">
          <h4>Git ユーザー</h4>
          <p><code>path/to/settings</code>は、あなたの環境に合わせて読みかえてください。</p>
          <pre>
mkdir -p path/to/settings
cd path/to/settings
git clone git://github.com/inventit/moat-iot-get-started-vagrant.git.</pre>
          <h4>Git ユーザー以外</h4>
          <p>git を使わなくても、<a href="https://github.com/inventit/moat-iot-get-started-vagrant">GitHub page</a>からzipファイルをダウンロードしてツールをインストールすることができます。 「Download ZIP」ボタンを押下してダウンロードし、解凍してください。</p>
        </div>
        <p>チェックアウトしたディレクトリ (または、解凍してできたディレクトリ)のルートに移動してください。例えば、<code>path/to/settings</code>に移動し、<code>vagrant</code>コマンドを実行します。
        <pre>cd path/to/settings
vagrant up</pre>
        </p>
        <br />
        <p>初めてコマンドを実行する場合、この処理は(ネットワークの帯域に依存しますが)約10分程度かかります。コマンド実行すると、以下に示すようなログが表示されます。
        <pre>==> default: Box 'opscode_ubuntu-12.04-i386_chef-11.4.4' could not be found. Attempting to find and install...
    default: Box Provider: virtualbox
    default: Box Version: >= 0
==> default: Adding box 'opscode_ubuntu-12.04-i386_chef-11.4.4' (v0) for provider: virtualbox
    default: Downloading: https://opscode-vm.s3.amazonaws.com/vagrant/opscode_ubuntu-12.04-i386_chef-11.4.4.box
==> default: Successfully added box 'opscode_ubuntu-12.04-i386_chef-11.4.4' (v0) for 'virtualbox'!
==> default: Importing base box 'opscode_ubuntu-12.04-i386_chef-11.4.4'...
==> default: Matching MAC address for NAT networking...
     :
   (snip)
     :
[2014-03-13T00:29:35+00:00] INFO: execute[add APP env] ran successfully
[2014-03-13T00:29:35+00:00] INFO: Chef Run complete in 396.508700733 seconds
[2014-03-13T00:29:35+00:00] INFO: Running report handlers
[2014-03-13T00:29:35+00:00] INFO: Report handlers complete</pre>
        </p>
        <h3>USBを有効にする</h3>
        <p>作成されたイメージは、USB接続が許可されていませんので、VirtualBoxの画面から手動で有効にする必要があります。</p>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          USBを有効にするためには、Oracle VM VirtualBox Extension Pack をインストールする必要があります。
          <a href="https://www.virtualbox.org/wiki/Downloads">ここ</a>からダウンロードしてインストールしてください。</div>
        <p> 1. Androidデバイスに接続されているケーブルを切断してください。<br />
          2. 仮想マシンのインスタンスを終了させてください。<br />
        <pre>vagrant halt</pre>
        </p>
        <p> 3. VirtualBox の画面を起動して、作成されたイメージを選択し、"Settings" をクリックしてください。<br />
        <div class="img-photo">
          <img src="/img/guides/get-started_p01.jpg" width="400" alt="Responsive image" class="img-responsive" />
        </div>
          4. "Ports" をクリックして"USB" タブを選択し、チェックボックスを有効にしてください。<br />
        <div class="img-photo">
          <img src="/img/guides/get-started_p02.jpg" width="400" alt="Responsive image" class="img-responsive" />
        </div>
          5. 再度、インスタンスを立ち上げます。<br /><br />
        <pre>vagrant up</pre>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          Oracle VM VirtualBox Extension Pack をインストールしていない場合、コマンド実行時にエラーが発生します。
          エラーが発生した場合、<a href="https://www.virtualbox.org/wiki/Downloads">ここ</a>からダウンロードしインストールした後、再度上記のコマンドを実行してください。</div>
        </p>
        <p> 6. USBケーブルを、Androidデバイスに接続してください。</p>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          <p>USBデバッグが許可されている場合、以下に示すようなダイアログが表示されるかもしれません。</p>
          <p><img src="/img/guides/get-started_p02-1.png" width="200" alt="Responsive image" class="img-responsive" /></p>
          <p>その場合、OKボタンを押下してください。</p> </div>
        <p> 7. ADBデーモンを起動するため、以下のコマンドを実行してください。</p>
        <pre>sudo adb kill-server
sudo adb devices</pre>
        </p>
        <p> 8. すると、以下のように出力されます。
        <pre>List of devices attached 
HT9ABC999999	device</pre>
        </p>
        <p><I>(HT9ABC999999 は例です。)</I><br />
          以上で、準備完了です！</p>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          <p>不運にも、ホットプラグインが動作しない場合、以下に示すように、"+" アイコンを押下し手動で接続を追加する必要があります。</p>
		  <br />
          <p>Macの場合:<br /><img src="/img/guides/get-started_p02-2.png" width="400" alt="Responsive image" class="img-responsive" /></p><br />
          <p>Windowsの場合:<br /><img src="/img/guides/get-started_p02-3.png" width="400" alt="Responsive image" class="img-responsive" /></p><br />
          USBを一度有効にすると、再度設定する必要はありませんが、<code>vagrant up</code>を実行した際には、<code>sudo adb devices</code>を実行した後 USB 接続することを覚えておいてください。</div>
          
        <h3>Using your cooked image</h3>
        <p><code>vagrant up</code> コマンドを実行した後は、全てのコマンドを<code>vagrant ssh</code>経由で実行しなければなりません。(Windowsユーザーは、<a href="get-started/for-windows.html">ここ</a>を確認してください。)
          実行中のインスタンスは、<code>vagrant halt</code>コマンドで終了させることができます。
          このイメージは、以下に示す環境変数を既に含んでいます。
        <ul>
          <li><code>CLI</code> IIDN コマンドラインツールのインストールディレクトリです。(<code>$CLI</code>と記述します)</li>
          <li><code>APP</code> MOAT IoT のサンプルアプリがチェックアウトされたディレクトリです。(<code>$APP</code>と記述します)</li>
        </ul>
        </p>
        <p>従って、本チュートリアルでは、コマンドをコピーすれば問題ありません。</p>
        
        <h3>サインアップ</h3>
        <p><a href="https://github.com/">GitHub</a>アカウントか、<a href="https://www.facebook.com/">Facebook</a>アカウントでサインアップすることができます。我々は OAuth2 プロバイダーのサービスをまだ提供していません。BitBucket と LinkedIn が OAuth2 に対応した際には、それらの対応を予定しています。(BitBucket と LinkedIn は、まだ OAuth2 に対応していません。)
          GitHub のサインアップするために、vagrant 環境で以下のコマンドを実行してください。(ログインするために、<code>vagrant ssh</code>を実行してください。)
        <pre>sh $CLI/iidn signup github</pre>
        <I>(IIDN コマンドラインツールのディレクトリを示す<code>$CLI</code>は、既にvagrantイメージで定義されているため、そのまま使うことができます。)</I><br />
        Facebookアカウントを利用する場合は、<code>github</code>の代わりに<code>fb</code>を指定してください。
        </p>
        <p>すると、以下に示すようなコマンドログが表示されます。<br />
          利用許諾に目を通したのち、<code>yes</code>と入力し、Enterを押下してください。</p>
        <pre>[IIDN] Please read and accept the Terms of Service: 
----------------------------- 
Inventit IoT Developer Network Terms of Service 
........... (snip)

----------------------------- 
[IIDN] Did you read and accept the terms? (yes/no): 
=> yes </pre>
        <pre>[IIDN] Opening Browser or you can enter the following URL manually:
=> https://www.github.com/login/oauth?client_id=9999999999999999999&redirect_uri=http%3A%2F%2Fdev.yourinventit.com/tools/oauth2callback&scope=user
[IIDN] Enter the authorization code: 
=> </pre>
        <div class="alert alert-warning"> <strong>重要:</strong><br />
          リモートマシンやvagrantイメージ上でコマンドを実行した場合、コマンドラインツール(iidn-cli)は、ブラウザを起動することができません。その場合、ブラウザを手動で立ち上げ、ターミナルに表示されるURLをブラウザにコピーしてください。</div>
        <p>'Allow'ボタンを押下すると、IIDNの認証コードが表示されます。<br />
          または、以下のページが表示されるかもしれません。(アイコンは違うかもしれませんが。) その場合は、'Go to App'ボタンを押下してください。</p>
        <div class="img-photo">
          <p><img src="/img/guides/get-started_p03.jpg" width="600" alt="Responsive image" class="img-responsive" /></p><br />
          <p><img src="/img/guides/get-started_p04.jpg" width="600" alt="Responsive image" class="img-responsive" /></p>
        </div>
        <div class="img-photo">
          <p><img src="/img/guides/get-started_p11.png" width="600" alt="Responsive image" class="img-responsive" /></p>
        </div><p>以下に示すページは、GitHub や Facebook が発行した認証コードを示します。<br />
          <I># もしかしたら、最新の Chrome を使っている場合、白い背景のHTMLページが表示されるかもしれません (これは、非SSLのコンテンツをブロックしているためです)。
            認証コードは、問題なく利用することができます。</I>
        <p>それでは、認証コードをプロンプトに貼り付けてください。
        <pre>[IIDN] Enter the authorization code: 
=> aaaaaaaaaaaaaaaaaaaaaaa</pre>
        </p>
        <p>最後に、あなたのデバイスを登録するための認証情報と、開発に利用するアプリケーション ID が発行されます。
        <pre>[IIDN] Congratulations! Welcome my@account.com to Inventit IoT Developer Network Sandbox!
[IIDN] =====================
[IIDN] Registration Info:
[IIDN] app_id :xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
[IIDN] client_id :admin@999999999999999999
[IIDN] client_secret :aaaaaaaaaaaaaaaaaaaaaaa
[IIDN] <notice!> The information is used in order for your application to access IIDN Cloud Sandbox.
[IIDN] =====================</pre>
        </p>
        <div class="alert alert-info"> <strong>Tips!</strong><br />
          <p>上記 3 つの認証情報を、以下のようにテキストファイルに保存しておくと、<code>iidn-cli</code>コマンド実行時に簡単に入力することができます。
<pre>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
admin@999999999999999999
aaaaaaaaaaaaaaaaaaaaaaa
</pre>
<p>
<code>iidn-cli</code>に認証情報の入力を促された際に、個別に入力する必要はなく、3行全ての認証情報をコピーすることで、一回の操作で全ての認証情報を入力することができます。
</p>
</div>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          上記の認証情報を忘れてしまっても、問題ありません。
          <code>reset</code>コマンドを実行することにより、全ての認証情報を再発行することができます。このコマンドは、<a href="https://github.com/inventit/iidn-cli">iidn-cli version 1.0.1</a> より利用することができます。</div>
        <p>それでは、GitHub からチェックアウトし、最初のアプリケーションを作成する次のステップに進みましょう。</p>
        <div id="Checkout-Sample-Project-from-GitHub">
          <h2>GitHubからサンプルプロジェクトをチェックアウトする</h2>
        </div>
        
        <h3>前提条件</h3>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          <a href="https://github.com/inventit/moat-iot-get-started-vagrant">moat-iot-get-started-vagrant</a>を利用して、<a href="http://www.vagrantup.com/">Vagrant</a>で環境構築している場合は、本章は読み飛ばして、次のステップに進みましょう。</div>
        <p>私たちは、ServiceSync プラットフォームで動作するサンプルプロジェクトを提供しています。サンプルプロジェクトを試すために、以下の事項を確認してください。</p>
        <ol>
          <li>インターネットに接続できること。</li>
          <li>モダンなブラウザ (Chromeであれば問題ありません)。</li>
          <li>Android 端末 (2.3/Gingerbread か、それよりも新しいバージョン) で、適切にGoogle Accountが設定されていること。</li>
          <li>Rails 3.2</li>
          <li>Java SE JDK 6 (Open JDK でも同様に動作するので問題ありません。<code>java</code>コマンドを実行できるように、<code>PATH</code> を設定してください。)
            JDK7 は、Android SDKにサポートされていないため、利用できません。</li>
          <li>Android SDK API Level 16 (<code>adb</code> コマンドを実行できるように、<code>PATH</code> を設定してください。)</li>
          <li>Apache Maven(3.0.x, <code>mvn</code>コマンドを実行できるように、<code>PATH</code>を設定してください。) または、eclipse に ADT をインストールしてください。</li>
          <li>Rails 3.2 と JDK 6、Android SDK が動作するPC。</li>
          <li>Open SSL (Windows バイナリは、<a href="http://slproweb.com/products/Win32OpenSSL.html">ここ</a>から入手可能です。)</li>
          <li>ServiceSync の Sandbox アカウント。(サインアップで払いだされた認証情報のことです。)</li>
        </ol>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          チェックアウトしたルートディレクトリを、<code>$APP</code>と表記し、<code>iidn</code>コマンドラインツールのディレクトリを<code>$CLI</code>と表記します。
          そして、チュートリアルは、あなたのホームディレクトリから始まります。</div>

        <h3>MOAT js スクリプトパッケージのアップロード</h3>
        <p>Sandbox サーバに、MOAT js スクリプトをアップロードするところから始めましょう。この手続きを通して、どのアプリケーションパッケージを使用するか、Sandboxサーバに教えます。アップロードする前に、zipファイルを作成する必要があります。</p>
        <pre>cd $APP/simple-example-js
jar cf simple-example.zip simple-example 
sh $CLI/iidn jsdeploy ./simple-example.zip</pre>
        <br />
        <p>アップロードするファイルは、'package.json'と呼ばれるパッケージのメタデータファイルを含んでなければなりません。詳細は、<a href="/references/moat-rest-api-document.html#package">here</a>を参照してください。もちろん、他の手順でもzipファイルを作成することはできます。</p>
        <pre>[IIDN] Deploying a MOAT js package...
[IIDN] A new MOAT js package has been created.
[IIDN] Deployed package info:
[IIDN] package-id(name): simple-example
[IIDN] version: 1.0
[IIDN] => OK. </pre>
        <p> 問題ないですね？それでは、次に進みましょう。</p>
        
        <h3>ゲートウェイアプリケーションのインストール</h3>
        <p>サンプルのAndroidアプリケーションが、Sandboxサーバを利用するためには、<b>Inventit ServiceSync Gateway</b>をインストールする必要があります。ServiceSync Gatewayは、Google Playよりインストールすることができます。
          これは、ServiceSync Gateway をインストールすることができるリンクです。</p>
        <p><a href="https://play.google.com/store/search?q=pub:Inventit Inc.">
<img alt="Get it on Google Play" src="https://developer.android.com/images/brand/en_generic_rgb_wo_45.png" /></a></p>
        <p>このゲートウェイアプリケーションは、デバイスIDをデバイスの識別子として使用します。この情報は、Sandbox サーバに保存され、デバイスを識別するために使用されます。
          ゲートウェイは、IMEI、ESN、MEID、Wi-FiのMACアドレス、もしくはOSに依存するデバイスIDを、デバイス識別子として使うかもしれません。(この仕様は、OSやミドルウェアが更新されることにより変更されることがあります。)
          この情報は、私たちの<a href="/legal/privacy-policy.html">プライバシー規約</a>に基づき取り扱われます。</p>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          一旦、あなたの Android デバイスが、Sandboxサーバに登録されると、このゲートウェイアプリケーションはバックグラウンドサービスとして動作します。
          タスクのキューイング状態を確認するため、最小5分の間隔で Sandbox 環境をポーリングします。このポーリング手段は、<a href="http://en.wikipedia.org/wiki/Push_technology">ロングポーリング</a>と呼ばれます。
          ポーリング間隔は、あなたのデバイスのネットワーク環境が良好であれば、2時間まで増大します。
          もしトラブルに見舞われた場合は、私たちにお知らせください。</div>
        
        <h3>Android アプリケーション</h3>
        <p>さぁ、Android アプリケーションのサンプルを確認してみましょう。チェックアウトしたソースコードは、ビルドしても正常に動作しません。なぜならば、ゲートウェイアプリケーション及び Sandbox サーバと対話するための情報がないためです。</p>
        <p>以下に示す項目が、あなたがやるべきことです。</p>
        <ol>
          <li>MOAT Android API jar のダウンロード</li>
          <li>セキュアトークンのダウンロード</li>
          <li>APK の署名鍵でセキュアトークンに署名する</li>
          <li>セキュアトークンを assets/moat フォルダにコピーする</li>
        </ol>
        
        <div id="Download_MOAT_Android_API">
          <h3>MOAT Android API jar のダウンロード</h3>
        </div>
        <p>以下に示すように、cli ツールで jar ファイルをダウンロードします。</p>
        <pre>sh $CLI/iidn sysdownload \
  inventit-dmc-android-lib-api-4.0.0-prod.jar</pre>
        <p>このコマンドは、認証情報の入力を求めます。</p>
        <pre>[IIDN] ** Using node... **
[IIDN] Please read and accept the EULA:
-----------------------------------------------------------
Inventit Binary Code License Agreement for the Inventit ServiceSync
-----------------------------------------------------------
........... (snip)

[IIDN] Did you read and accept the agreement? (yes/no):
yes
[IIDN] Enter your appId:
(your-application-id)
[IIDN] Enter your clientId:
(your-client-id)
[IIDN] Enter your password:
(your-client-secret)
[IIDN] Downloading the distribution package...
[IIDN] The package:[inventit-dmc-android-lib-api-4.0.0-prod.jar] has been downloaded.</pre>
        <p>それから、<code>mvn</code>コマンドで、ローカルリポジトリにそれらをインストールします。</p>
        <pre>mvn install:install-file \
-Dfile=inventit-dmc-android-lib-api-4.0.0-prod.jar \
-DgroupId=com.yourinventit \
-DartifactId=inventit-dmc-android-lib-api \
-Dversion=4.0.0 -Dclassifier=prod -Dpackaging=jar</pre>
        <p>すると、成功を示すメッセージが表示されるはずです。</p>
        <pre> :
(snip)
  :
[INFO] ---------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ---------------------------------------------------
[INFO] Total time: 1.060s
[INFO] Finished at: Wed Jan 09 18:22:17 JST 2013
[INFO] Final Memory: 8M/81M
[INFO] ----------------------------------------------------</pre>
        
        <h3>セキュアトークンのダウンロード</h3>
        <p>以下のコマンドを実行することで、Sandbox サーバからセキュアトークンをダウンロードすることができます。</p>
        <pre>sh $CLI/iidn tokengen <code>simple-example</code></pre>
        <p><code>simple-example</code>は、パッケージIDと呼ばれる、アプリケーションパッケージに割り当てられる識別子で、MOAT js スクリプトアーカイブ(zipファイル)をアップロードした際に、登録された識別子です。<br />
          コマンドは、多くの情報を表示します。</p>
        <br />
        <p>コマンドが正常終了すると、最後の数行は、以下のように表示されるはずです。</p>
        <pre>  :
(snip)
  :
[IIDN] $ openssl pkcs12 -in your-new.p12 -clcerts -nokeys -out your.cert.pem
[IIDN] ----------------------------------------------------
[IIDN] $ openssl pkcs12 -in your-new.p12 -nocerts -out your.key
[IIDN] ----------------------------------------------------
[IIDN] Done</pre>
        <p>ダウンロードされたファイルは、<code>.bin</code>という拡張子の付与され、現在の作業ディレクトリに保存されます。
		<pre>vagrant@vagrant:~/moat-iot-get-started/simple-example-js$ ls -al
total 588
drwxr-xr-x 3 vagrant root      4096 Mar 14 03:43 .
drwxr-xr-x 9 vagrant root      4096 Mar 13 10:27 ..
-rw-rw-r-- 1 vagrant vagrant   1750 Mar 14 03:43 1394768569891-token.bin</pre>
    この例では、<code>1394768569891-token.bin</code>というファイル名で保存されています。このファイルは、<code>download-file.bin</code>というファイルで、本ドキュメントの後半で参照されます。</p>
        <h4>セキュアトークンに署名する</h4>
        <p>セキュアトークンをダウンロードした後、あなた自身の鍵で署名する必要があります。この例では、簡略化のため、Androidのデバッグキーで署名する方法を示します。ただし製品版では、この方法は決して使用しないでください。</p>
        <br />
        <p>最初に、デバッグ用のキーストアのフォーマットを変更する必要があります。以下のコマンドを実行してください。</p>
        <pre>keytool -importkeystore -srckeystore $HOME/.android/debug.keystore -destkeystore $HOME/.android/debug.p12 -deststoretype PKCS12</pre>

        <div class="alert alert-warning"> <strong>IMPORTANT:</strong><br />
          上記の<code>keytool</code>コマンドでは、3回全てのプロンプトで、同じパスワードを入力しなければなりません。そうでなければ、秘密鍵をエクスポートする際に、OpenSSLのエラーとなります。<pre>
Error outputting keys and certificates
140044161410720:error:06065064:digital envelope routines:EVP_DecryptFinal_ex:bad decrypt:evp_enc.c:539:
140044161410720:error:23077074:PKCS12 routines:PKCS12_pbe_crypt:pkcs12 cipherfinal error:p12_decr.c:104:
140044161410720:error:2306A075:PKCS12 routines:PKCS12_item_decrypt_d2i:pkcs12 pbe crypt error:p12_decr.c:130:</pre>
			
		</div>

        <p><I>もし、以下のようなエラーになった場合は、<code>$HOME/.android</code>ディレクトリを作成してください。
            <pre>keytool error: java.io.FileNotFoundException: /home/vagrant/.android/debug.keystore (No such file or directory)</pre></I></p>
        <div class="bs-callout">
          <pre>mkdir $HOME/.android</pre>
		</div>

        <p><I>もし、<code>$HOME.android</code>(Windows ユーザの場合は、<code>%HOMEPATH%\.android</code>) が見あたらない場合, 以下のコマンドを実行してください。</I></p>
        <div class="bs-callout">
          <pre>keytool -genkey -keypass android -keystore \
$HOME/.android/debug.keystore -alias \
androiddebugkey -storepass android -validity 10000 \
-dname "CN=Android Debug,O=Android,C=US"</pre>
        </div>
        <br />
        <p>次に、フォーマット変換したファイルから、証明書と秘密鍵を取り出します。デバッグ用の証明書を取り出すには、以下を実行します。
          Next, you need to extract a certificate file and a private key from the converted file. For the debug certificate:</p>
        <pre>openssl pkcs12 -in $HOME/.android/debug.p12 -clcerts -nokeys -out $HOME/.android/debug.pem</pre>
        <br />
        <p>パスワードの入力を促された場合は、<code>keytool</code>コマンドと同じパスワードを入力します。秘密鍵を取り出すためには、以下を実行します。</p>
        <pre>openssl pkcs12 -in $HOME/.android/debug.p12 -nocerts -out $HOME/.android/debug.key</pre>
        <p>同様に、同じパスワードをパスフレーズを入力してください。<br />
          Android のデバッグ用キーストアは、<a href="http://developer.android.com/tools/publishing/app-signing.html#debugmode">ここ</a> から入手することができます。</p>
        <br />
        <p>最後に、セキュアトークンに署名するために以下のコマンドを実行します。ダウンロードした bin ファイルが、<code>download-file.bin</code>というファイル名にリネームされていることを確認してください。</p>
        <pre>openssl smime -sign -in download-file.bin -out signed.bin -signer $HOME/.android/debug.pem -inkey $HOME/.android/debug.key -nodetach -outform der -binary</pre>
        <p>この署名されたトークンは、<code>./signed.bin</code>に保存されます。</p>
        <h4>トークンを配置する</h4>
        <p>署名されたトークンを、<code>assets</code> ディレクトリに移動します。</p>
        <pre>mv ./signed.bin $APP/simple-example-android/assets/moat</pre>
        
        <h3>ビルドしてサンプル APK をインストールする</h3>
        <p> Android デバイスが、USBで接続されていることを確認してください。<br />
          eclipse IDE でも同様に、APKをビルドしてインストールすることができます。(<a href="http://stackoverflow.com/questions/4756451/how-to-install-an-apk-file-on-an-android-phone">このスレッド</a> が参考になるかもしれません。).</p>
        <pre>cd $APP/simple-example-android
mvn clean deploy</pre>
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          もしコンパイルエラーが発生した場合、再度<code>inventit-dmc-android-lib-api-4.0.0-prod.jar</code>をダウンロードしてインストールしてください。ダウンロード方法は、<a href="#Download_MOAT_Android_API">ここ</a> を参考にしてください。</div>
        <p>次に、ビルドしたAPKをインストールします。</p>
        <pre>adb install target/moat-android-simple.apk</pre>
        
        <div class="alert alert-info"> <strong>NOTE:</strong><br />
          <p>vagrantイメージのユーザーは、上記コマンドを実行する前に、<code>sudo adb devices</code>を実行しなければなりません。もし、<code>- waiting for device -</code> という表示のまま何も反応しない場合は、以下のコマンドを実行してください。</p>
          <pre>adb kill-server
sudo adb devices
adb logcat -v</pre>
          <p>そして、vagrant のインスタンスではなく、ホストマシンを含む他のインスタンスが Android デバイスの USB 接続を使用していないか確認してください。</p>
        </div>
        <p>インストールが正常終了すると、以下のログが出力されます。(転送レートとバイナリサイズがあなたの表示内容と異なっていると思いますが。)</p>
        <pre>431 KB/s (518685 bytes in 1.174s)
	pkg: /data/local/tmp/moat-android-simple.apk
Success</pre>
        <p>以下のコマンドを実行すると、Androidデバイスのログをtailすることもできます。</p>
        <pre>adb logcat -v time</pre>
        <p>このコマンドは、以下のような出力を表示します。</p>
        <pre>01-09 18:45:42.413 D/dalvikvm(24064): GC_CONCURRENT freed 1960K, 56% free 4495K/10055K, external 2797K/3480K, paused 7ms+5ms
01-09 18:45:42.413 D/dalvikvm(24064): GC_CONCURRENT freed 1456K, 56% free 4463K/10055K, external 2797K/3480K, paused 6ms+3ms
01-09 18:45:42.413 D/dalvikvm(24064): GC_EXPLICIT freed 376K, 56% free 4455K/10055K, external 2797K/3480K, paused 77ms
  :
(snip)
  :
</pre>
        <p>では、Rails アプリに移りましょう。このアプリは、<code>simple-example-rails</code> ディレクトリに配置されています。</p>
        
        <h3>認証情報の設定と Rails の準備</h3>
        <p> Rails アプリケーションは、IIDN の Sandbox サーバに接続するための認証情報を必要とします。最初に、<code>config/initializers/constants.rb</code>を開くと、以下に示すような内容を確認することができます。</p>
        <pre># Modify here with your credentials
APPLICATION_ID = "{:your_application_id}"
API_CLIENT_ID = "{:your_client_id}"
API_CLIENT_SECRET = "{:your_client_secret}"</pre>
        <p>次に、<code>{:your_application_id}</code>、<code>{:your_client_id}</code>、<code>{:your_client_secret}</code> を、それぞれ <code>app_id</code>、<code>client_id</code>、<code>client_secret</code> に置き換えてください。</p>
        <br />
        <p>コンソールから、以下のコマンドを入力してください。</p>
        <pre>cd $APP/simple-example-rails
bundle install
bundle exec rake db:migrate</pre>
        <p>一度、<code>bundle install</code>と<code>bundle exec rake db:migrate</code>を実行すると、次回から実行する必要はありません。</p>
        
        <div id="Kick-off-your-first-IoT-app">
          <h2>最初の IoT アプリを起動する</h2>
        </div>
        <h3>Webアプリをローカルホストで起動する</h3>
        <p>コマンドラインで、以下のコマンドを実行します。</p>
        <pre>cd $APP/simple-example-rails
bundle exec rails server</pre>
        <p>数秒後、以下のようなメッセージを確認することができます。</p>
        <pre>=> Booting WEBrick
=> Rails 3.2.11 application starting in development on http://0.0.0.0:3000
=> Call with -d to detach
=> Ctrl-C to shutdown server
[2014-03-13 10:37:11] INFO  WEBrick 1.3.1
[2014-03-13 10:37:11] INFO  ruby 2.1.0 (2013-12-25) [i386-linux-gnu]
[2014-03-13 10:37:11] INFO  WEBrick::HTTPServer#start: pid=15065 port=3000</pre>
        <br />
        <p> Rails が起動しました。<br />
          ブラウザから、<code>http://localhost:3000</code> にアクセスしてください。すると、以下のようなページを確認することができます。</p>
        <div class="img-photo">
          <p><img src="/img/guides/get-started_p05.jpg" width="600" alt="Responsive image" class="img-responsive" /></p>
        </div>
        
        <h3>サーバ側のログを Tail する</h3>
        <div class="alert alert-warning"> <strong>IMPORTANT:</strong><br />
          不運なことに、この機能は現在利用することができません。ロードバランサーが、長時間の TCP 接続を切断するためです。今後、他の手段を用意する予定です。
        </div>
        <p>MOAT js の MessageSesion.log API 経由で発行される MOAT js のサーバログを、遠隔から確認することができます。
          サーバーに接続されている間、サーバーのログがコマンドラインに出力され続けます。</p>
        <pre>$ sh ./iidn log</pre>
        <p>認証情報を入力するよう促されます。</p>
        <pre>[IIDN] ** Using node... **
[IIDN] Enter your appId:
(your-application-id)
[IIDN] Enter your clientId:
(your-client-id)
[IIDN] Enter your password:
(your-client-secret)
[IIDN] Tailing the MOAT js server script log:</pre>
        <p>認証が成功すると、コマンドラインは待機状態になります。ログは、上の行に引き続き順番に出力されます。</p>
        
        <h3>Android アプリをタップ＆シェイクする</h3>
        <p>Android デバイスに戻ります。MOAT アイコンをタップして起動してください。<br />
          Android アプリが起動して、以下の画面が表示されます。</p>
        <div class="img-photo">
          <p><img src="/img/guides/get-started_p06.jpg" width="300" alt="Responsive image" class="img-responsive" /></p>
        </div>
        <p>アプリ起動後、約30秒程度で、初期化処理が完了します。(これをアクティベーションと呼びます。)
          アプリケーションの使用許諾契約に合意するよう促されるかと思いますが、使用許諾契約を読み受諾(Accept)してください。すると、次のステップに進むことができます。<p>
        <p>アクティベーションが完了すると、デバイスの情報が、このように Rails アプリに表示されます。</p>
        <div class="img-photo">
          <p><img src="/img/guides/get-started_p07.jpg" width="600" alt="Responsive image" class="img-responsive" /></p>
        </div>
        <p>"Morse Code"ボタンを押下してください。すると、SOSのモールス信号が Android デバイスに送信され振動します。"Morse Code"ボタンをクリックすると、画面が以下のように変わります。</p>
        <div class="img-photo">
          <p><img src="/img/guides/get-started_p08.jpg" width="600" alt="Responsive image" class="img-responsive" /></p>
        </div>
        <p>見ての通り、"Active Requests" に、エントリが一つ追加されています。これは、<a href="/references/moat-rest-api-document.html#dmjob">dmjob</a> のレコードです。dmjob のオブジェクトは、自身でライフサイクルを持っています。そして、ジョブの実行が完了するかタイマーが満了すると終了します。
          <a href="/references/moat-rest-api-document.html#dmjob">dmjob</a>が完了すると、"Active Requests" のリストはクリアされ、"Request History" に "Ended At" 属性をともなったエントリが追加されます。
          履歴レコードは、cloud側のサーバに保存されるのではなく、Rails アプリ側で保存されることに注意してください。<br />
          このサンプル Web アプリは、"Morse Code" のリクエスト履歴を保存しません。なぜならば、Web アプリは、Sandbox サーバーからジョブの完了通知を受信することができないからです。そのため、"Morse Code" のリクエストが表示されなくなっても気にしないでください。私たちは、Heroku 上で動作する他のサンプルを提供予定です。このサンプルアプリは、完了通知を受信し、履歴を適切に管理するアプリケーションです。</p>
        <div class="img-photo">
          <p><img src="/img/guides/get-started_p09.jpg" width="600" alt="Responsive image" class="img-responsive" /></p>
        </div>
        <p>このデモは、SOSモールス信号以外にも、モーションイベントの情報を保存する機能も提供しています。<br />
          Android デバイスのアプリ画面が表示されている状態で、何度か素早く Android デバイスをシェイクしてください。
           <strong>(画面がロックされている状態だと何も起きません！)</strong>. 何も起きなかったら、何度か繰り返し試してみてください。</p>
        <br />
        <p>すると、モーションセンサーのデータが Sandbox Server にアップロードされるので、Rails アプリの画面をリロードすると、モーションイベントの情報が表示されるはずです。確認してみてください。</p>
        <div class="img-photo">
          <p><img src="/img/guides/get-started_p10.jpg" width="600" alt="Responsive image" class="img-responsive" /></p>
        </div>
        <p>"Morse Code" ボタンの隣の "Delete" ボタンは、Sandbox サーバーの制御から解放するために使います。一度、デバイスを解放すると、ゲートウェイアプリケーションの<a href="https://www.google.co.jp/search?q=android+clear+data&tbm=vid">データをクリア</a>しなければなりません。</p>
        <p>ところで、サーバーアプリのログには、何が出力されているでしょう？<br />
          以下に示すようなログが表示されているはずです。</p>
        <pre>[IIDN] 2013-01-09 21:58:56,885 JST <94> [vibrate] Start VibrateDevice!
[IIDN] 2013-01-09 21:58:56,885 JST <94> [vibrate] args => {"options":[0,0,0,200,200,200,200,200,500,500,200,500,200,500,500,200,200,200,200,200,1000,200,200,200,200,200,500,500,200,500,200,500,500,200,200,200,200,200],"http.set":"true"}
[IIDN] 2013-01-09 21:58:57,568 JST <95> [vibrate:vibrate] Successful!!
[IIDN] 2013-01-09 21:58:57,568 JST <95> [vibrate] End VibrateDevice!
[IIDN] 2013-01-09 22:35:04,204 JST <86> [shake] Start ShakeEvent!
[IIDN] 2013-01-09 22:35:05,000 JST <86> [shake:save] The object@uid:39ab2ec3-1240-487c-bd9d-2cb2fba15fa9 has been saved to the database.
[IIDN] 2013-01-09 22:35:05,285 JST <86> [shake:save] The object@uid:6aac601d-347c-443a-8c4c-49ec21d036d4 has been saved to the database.
[IIDN] 2013-01-09 22:35:05,564 JST <86> [shake:save] The object@uid:c506fc23-d05e-4c3e-93c8-60469c37fbe9 has been saved to the database.
[IIDN] 2013-01-09 22:35:05,847 JST <86> [shake:save] The object@uid:e387e2b5-6fdc-4e66-9b30-fa0f2ef1b80c has been saved to the database.
[IIDN] 2013-01-09 22:35:05,866 JST <86> [shake] => 1 objects are stored.</pre>
        <p style="color:red"><strong>もう一度言いますが、この機能は、ロードバランサーが長時間の TCP 接続を切断することにより、利用することができません。今後、別の手段を準備する予定です。</strong></p>
        <p>チュートリアルは以上となります！<code>resource</code> のサンプルは、まだ準備できていませんのでスキップします。</p>
        
        <div id="Appendix">
          <h3>Appendix</h3>
        </div>
        
        <h3>サンプルアプリについて、さらに学ぶ</h3>
        <p>このチュートリアルの目的は、Sandbox サーバーでアプリを動作させてみることです。ここで、サンプルアプリで何が行われているか説明しています。</p>
        
        <h3>アンデプロイする</h3>
        <p>アプリがもはや必要ない場合は、MOAT js スクリプトパッケージを削除することができます。</p>
        <pre>$ sh ./iidn jsundeploy simple-example</pre>
        コマンドを実行した後、以下のような結果が表示されます。
        <pre>[IIDN] Undeploying the MOAT js package...
[IIDN] Done.</pre>
        
        <!-- col-lg-9 End --> 
      </div>
      <!-- row End --> 
    </div>
    <!-- container End --> 
  </div>
</section>
